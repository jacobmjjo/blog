---
title: "CDN S3 정적 웹사이트로 우회 하는 법"
date: 2022-04-12T10:36:04+09:00
slug: ""
description: ""
keywords: ["AWS", "CDN", "S3"]
draft: true
tags: ["AWS", "CDN", "S3"]
math: false
toc: false
---

고객사에서 웹서버 작업기간 동안 정적 웹사이트로 되어있는 중지배너를 올려달라고 요청이 왔다.  
아키텍처로 그리면 아래와같다.  
![구성하려는 아키텍처](/img/cdn_s3_http/Untitled.png)  

여기서 특이한 점은 S3에서 html을 호스팅하는 구조인데 AWS S3은 정적 웹사이트를 호스팅 하는 기능을 가지고 있다.  
실제로 s3 공식문서에도 관련 내용을 상세하게 설명해 준다  
[Amazon S3를 사용하여 정적 웹 사이트 호스팅](https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/WebsiteHosting.html)

자연스레 S3에서 정적 웹사이트를 호스팅 할 수 있다면 CDN과 연결해서 사용하는 것도 가능하다.  
[[AWS] CloudFront와 S3 연결하기](https://earth-95.tistory.com/128)

다만 이번 요청사항에는 2가지 제약 사항이 있다. 

1. 기존 도메인을 유지하면서 모든 요청을 s3로 가게끔 경로 수정
2. 도메인 뒤에 /후 어떠한 값을 넣더라도 무조건 정적페이지 출력

검색해서 볼 수 있는 블로그에는 생성 관련된 내용을 주로 공유하기에 제약 조건에 맞게 작업을 하기에는 사전 테스트가 필요했다.  
최대한 고객사의 아키텍처와 유사하게 만들기 위해 리소스들을 먼저 생성했다.  
필요한 리소스는 EC2, ALB, S3, CDN, SSL 인증서 였다. 
SSL인증서는 고객사에서 제공해 주었기 때문에 해당 블로그에서 생략 했다.  
우선 정적 웹사이트를 올리기 위해 s3를 먼저 생성했다. s3 생성 가이드는 워낙 많기 때문에 아무거나 참고해서 생성하면 되는데 퍼블릭 액세스만 막으면 된다.  

![퍼블릭 액세스 거부 설정 화면](/img/cdn_s3_http/Untitled%201.png)  

그 후 본인이 원하는 정적웹사이트를 버킷에 추가했다.  

![버킷에 웹사이트 추가한 모습](/img/cdn_s3_http/Untitled%202.png)

원래는 버킷 속성에서 정적 웹사이트 호스팅을 할수가 있다. 하지만 CDN을 연결해서 호스팅 할 것이기에 굳이 s3에서는 설정을 하지 않았다.  
이제 s3를 만들었으니 cdn과 연결해보자  
CDN으로 들어가서 배포 생성을 누르면 원본을 입력 하라는 항목이 나온다. 

> 여기서 중요한 부분이 S3 버킷 엑세스 부분인데 **CloudFront 원본 엑세스(OAI)를 사용해야지만** 버킷을 퍼블릭 허용으로 하지않아도 외부에서 정적 웹사이트에 접속 할 수 있다.
> 

![Untitled](/img/cdn_s3_http/Untitled%203.png)

잘 되는지 확인 하기 위해 url에 도메인을 입력해보자  

![Untitled](/img/cdn_s3_http/Untitled%204.png)

그럼 이제 s3에 올린 html파일로 도메인만 입력 했을때 자동으로 접근할 수 있도록 기본값 루트를  설정한다.  
수정하려는 CDN에서 일반을 누르고 편집을 누르면 아래의 기본 루트객체를 수정 할 수 있다.  

![Untitled](/img/cdn_s3_http/Untitled%205.png)

![Untitled](/img/cdn_s3_http/Untitled%206.png)

변경을 완료하고 도메인만으로 접속을 해서 잘 들어 간다면 정상적으로 적용 된 것이다.  

![Untitled](/img/cdn_s3_http/Untitled%207.png)  

그럼 이제 고객사 환경과 최대한 유사하게 만들기 위해 웹서버를 설치하여 연결해 보겠다.  
ec2를 하나 생성하고 그 안에 Nginx를 설치했다. 그리고 cdn 연결에 필요한 ALB를 만들었다.  
만약 ALB없이 바로 ec2로 연결면 아래와 같이 origin을 찾을 수 없다는 에러가 발생한다.  

![Untitled](/img/cdn_s3_http/Untitled%208.png)

이러한 문제로 ALB를 설치하고 ec2에 연결해야 한다.(만약 ec2가 퍼블릭 도메인을 가지고 있다면 될수도 있을 것 같다.)  
ALB를 설치하고 EC2와 연결을 완료하면 CDN 원본 목록에서 ALB 도메인을 확인 할 수있다. 등록 방법은 앞서 S3 방법과 동일하다.  

그럼 원본 등록을 마쳤다면 동작에서 원본을 반드시 수정해야 한다.  

![Untitled](/img/cdn_s3_http/Untitled%209.png)

수정 후 도메인에 웹서버 안에 있는 index.html 주소를 입력하면 nginx가 나온다.  

![Untitled](/img/cdn_s3_http/Untitled%2010.png)

지금은 기본 루트 객체를 수정하지 않아서 index.html을 url에 입력해야 한다. 기본 루트 객체를 디폴트로 수정하면 도메인만 입력해도 nginx 화면을 볼 수있다.  
여기까지 제약 사항 중 1번은 다 준비가 된 상황이다.  
동작에서 모든 작업의 원본을 S3로 변경 하기만 하면 아키텍처 처럼 경로가 형성된다.  

그럼 남은건 도메인 뒤에 어떠한 값을 입력 하든지 간에 정적 웹사이트를 뜨도록 하는 방법이다.  
지금 이상한 경로를 입력해서 진입하면 Access Denied가 발생한다.  

![Untitled](/img/cdn_s3_http/Untitled%2011.png)

그러면 어떻게 해야 하느냐 바로 **오류 페이지에서 오류시 중지배너를 호스팅 할 수 있도록 설정을 하면 해결된다.**  

![Untitled](/img/cdn_s3_http/Untitled%2012.png)

현재 설정된 오류 페이지의 목록이다. 오른쪽에 응답 페이지 경로를 보면 아무런 표시가 없다.  
응답 페이지 경로에 S3 정적 웹사이트 위치를 추가하면 된다.  

![Untitled](/img/cdn_s3_http/Untitled%2013.png)

아까와 동일한 url을 입력하면 정적 웹사이트가 뜨는 것을 확인 할 수 있다. 

![Untitled](/img/cdn_s3_http/Untitled%2014.png)

오류 코드는 여러가지를 추가 할 수 있으니 상황에 맞춰서 설정 하면 된다.  

이렇게 오류 페이지 까지 설정하면 요청사항을 모두 만족할 수 있다.